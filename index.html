<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencarian Sertifikat Lomba</title>
    <!-- Memuat Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font agar terlihat profesional */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Warna latar belakang lembut */
        }
        /* Style untuk container utama */
        #app-container {
            max-width: 900px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" class="mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10 transition-all duration-300">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-700 mb-2">Pencarian Pemenang & Sertifikat Lomba</h1>
            <p class="text-gray-600">Temukan data peserta dan tautan unduhan sertifikat berdasarkan nama atau kategori lomba.</p>
        </header>

        <!-- Form Pencarian -->
        <div class="space-y-4 mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <!-- Input Nama -->
                <div class="md:col-span-1">
                    <label for="inputNama" class="block text-sm font-medium text-gray-700 mb-1">Nama Peserta</label>
                    <input type="text" id="inputNama" placeholder="Ketik nama lengkap atau sebagian..."
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                </div>

                <!-- Dropdown Kategori -->
                <div class="md:col-span-1">
                    <label for="selectKategori" class="block text-sm font-medium text-gray-700 mb-1">Kategori Lomba</label>
                    <select id="selectKategori"
                            class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="">-- Semua Kategori --</option>
                        <option value="Cerdas Cermat Matematika">Cerdas Cermat Matematika</option>
                        <option value="Karya Koding Blok">Karya Koding Blok</option>
                        <option value="Video Penerapan Pembelajaran Mendalam">Video Penerapan Pembelajaran Mendalam</option>
                    </select>
                </div>

                <!-- Tombol Cari -->
                <div class="md:col-span-1">
                    <button id="btnCari"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        Cari Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Area Hasil Pencarian -->
        <div id="loadingIndicator" class="text-center py-8 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"></div>
            <p class="text-blue-600 font-medium">Memuat data...</p>
        </div>

        <div id="resultsContainer" class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Hasil akan dimasukkan di sini -->
        </div>

        <div id="messageBox" class="text-center mt-8 py-4 px-6 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg hidden">
            <!-- Pesan seperti "Data tidak ditemukan" akan muncul di sini -->
        </div>

    </div>

    <script>
        // Variabel global
        const CSV_FILE_NAME = 'data.csv';
        let allData = [];

        // Elemen DOM
        const inputNama = document.getElementById('inputNama');
        const selectKategori = document.getElementById('selectKategori');
        const btnCari = document.getElementById('btnCari');
        const resultsContainer = document.getElementById('resultsContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');

        /**
         * Fungsi utilitas untuk membersihkan string CSV (menghapus tanda kutip dan spasi berlebih).
         * @param {string} str String input dari CSV.
         * @returns {string} String yang sudah dibersihkan.
         */
        function cleanString(str) {
            if (str && typeof str === 'string') {
                // Menghapus tanda kutip di awal dan akhir, serta spasi di awal/akhir
                return str.replace(/^"|"$/g, '').trim();
            }
            return ''; // Pastikan mengembalikan string kosong jika input tidak valid
        }

        /**
         * Mengambil dan memparsing file CSV.
         */
        async function loadCSV() {
            loadingIndicator.classList.remove('hidden');
            messageBox.classList.add('hidden');
            resultsContainer.innerHTML = '';
            
            try {
                let dataUrl = CSV_FILE_NAME; 

                // --- FIX: Memastikan penggunaan URL file yang diunggah di lingkungan Canvas ---
                const fileEntry = typeof __uploaded_files !== 'undefined' ? __uploaded_files[CSV_FILE_NAME] : null;
                
                if (fileEntry && fileEntry.contentFetchId) {
                    // Menggunakan Content Fetch ID yang disediakan oleh lingkungan Canvas
                    dataUrl = fileEntry.contentFetchId;
                } else {
                    // Mencegah panggilan fetch('data.csv') yang menyebabkan error 'Failed to parse URL'
                    // dan memberikan pesan error yang lebih informatif kepada pengguna.
                    throw new Error(`File '${CSV_FILE_NAME}' tidak dapat diakses. Pastikan file telah diunggah dan terdeteksi dengan benar di lingkungan Canvas.`);
                }
                // --- END FIX ---
                
                const response = await fetch(dataUrl);
                
                if (!response.ok) {
                    throw new Error(`Gagal memuat file CSV: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                // Memisahkan baris
                const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');

                if (lines.length < 2) {
                    throw new Error("File CSV kosong atau tidak memiliki data.");
                }

                // Header: Nama,Asal Sekolah,Kategori,Link Sertifikat
                // Header juga harus dibersihkan untuk memastikan kecocokan dengan data
                const headers = lines[0].split(',').map(h => cleanString(h));
                
                // Memparsing data baris
                allData = lines.slice(1).map(line => {
                    // Menggunakan regex sederhana untuk memisahkan koma yang tidak ada di dalam tanda kutip
                    // Ini adalah parser CSV dasar, mungkin gagal untuk CSV yang sangat kompleks.
                    const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];

                    if (values.length === 0) return null;

                    const row = {};
                    headers.forEach((header, i) => {
                        // Membersihkan nilai sebelum disimpan (penting untuk menghilangkan spasi di kategori)
                        row[header] = values[i] ? cleanString(values[i]) : '';
                    });

                    // Pastikan 4 kolom penting ada, dan Link Sertifikat ada nilainya
                    // Setelah dibersihkan, kita cek kembali ketersediaan data
                    if (row['Nama'] && row['Asal Sekolah'] && row['Kategori'] && row['Link Sertifikat']) {
                        return row;
                    }
                    return null; // Abaikan baris yang datanya tidak lengkap
                }).filter(item => item !== null); // Hapus baris yang gagal diurai atau tidak lengkap
                
            } catch (error) {
                console.error("Kesalahan saat memuat atau memparsing CSV:", error);
                showNotification(`Gagal memuat data: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                // Tampilkan pesan awal jika tidak ada data setelah memuat
                if (allData.length === 0) {
                     showNotification("Tidak ada data yang valid ditemukan dalam file CSV. Periksa format kolom: Nama, Asal Sekolah, Kategori, Link Sertifikat.", 'error');
                } else {
                    // Coba tampilkan semua hasil secara default setelah pemuatan sukses
                    handleSearch(); 
                }
            }
        }

        /**
         * Fungsi untuk menampilkan pesan notifikasi di messageBox
         * @param {string} message Pesan yang akan ditampilkan.
         * @param {string} type Tipe pesan (sukses, error, warning).
         */
        function showNotification(message, type = 'warning') {
            let bgColor = 'bg-yellow-100';
            let borderColor = 'border-yellow-300';
            let textColor = 'text-yellow-800';

            if (type === 'error') {
                bgColor = 'bg-red-100';
                borderColor = 'border-red-300';
                textColor = 'text-red-800';
            } else if (type === 'success') {
                bgColor = 'bg-green-100';
                borderColor = 'border-green-300';
                textColor = 'text-green-800';
            }
            
            messageBox.className = `text-center mt-8 py-4 px-6 ${bgColor} border ${borderColor} ${textColor} rounded-lg`;
            messageBox.innerHTML = `<p class="font-semibold">${message}</p>`;
            messageBox.classList.remove('hidden');
        }

        /**
         * Menampilkan hasil pencarian dalam bentuk card.
         * @param {Array} results Array data peserta yang ditemukan.
         */
        function renderResults(results) {
            resultsContainer.innerHTML = '';
            messageBox.classList.add('hidden');

            if (results.length === 0) {
                showNotification("Data peserta tidak ditemukan. Coba gunakan kata kunci lain.");
                return;
            }

            results.forEach(item => {
                const card = `
                    <div class="bg-white border border-gray-200 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 p-6 flex flex-col justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-500 mb-1">Nama Peserta:</p>
                            <h3 class="text-xl font-bold text-blue-800 mb-3">${item['Nama']}</h3>
                            
                            <p class="text-sm font-semibold text-gray-500 mt-3 mb-1">Asal Sekolah:</p>
                            <p class="text-base text-gray-700 font-medium">${item['Asal Sekolah']}</p>
                            
                            <p class="text-sm font-semibold text-gray-500 mt-3 mb-1">Kategori Lomba:</p>
                            <span class="inline-block bg-blue-100 text-blue-700 text-xs font-semibold px-3 py-1 rounded-full">${item['Kategori']}</span>
                        </div>
                        
                        <a href="${item['Link Sertifikat']}" target="_blank"
                           class="mt-6 w-full text-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-200 transform hover:scale-[1.02]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707l-.707-.707V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z" />
                            </svg>
                            Download Sertifikat
                        </a>
                    </div>
                `;
                resultsContainer.innerHTML += card;
            });
        }

        /**
         * Menjalankan logika pencarian (filter).
         */
        function handleSearch() {
            // Nilai input Nama dan Kategori sudah bersih dari spasi berlebih
            const namaQuery = inputNama.value.toLowerCase().trim();
            const kategoriQuery = selectKategori.value;

            if (allData.length === 0) {
                // Jangan tampilkan error jika sedang loading, hanya jika benar-benar kosong setelah loading
                if (loadingIndicator.classList.contains('hidden')) {
                     showNotification("Data belum dimuat atau kosong. Coba muat ulang halaman.", 'error');
                }
                return;
            }
            
            const filteredResults = allData.filter(item => {
                // Pencocokan Nama: selalu diubah ke huruf kecil untuk pencarian case-insensitive
                const namaMatch = item['Nama'].toLowerCase().includes(namaQuery);
                
                // Pencocokan Kategori: item['Kategori'] sudah dibersihkan saat loadCSV
                let kategoriMatch = true;
                if (kategoriQuery) {
                    kategoriMatch = item['Kategori'] === kategoriQuery;
                }
                
                return namaMatch && kategoriMatch;
            });

            renderResults(filteredResults);
        }

        // --- Event Listeners ---
        btnCari.addEventListener('click', handleSearch);

        // Menambahkan kemampuan pencarian saat menekan 'Enter' di input Nama
        inputNama.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSearch();
            }
        });
        
        // Memuat data saat halaman selesai dimuat
        window.onload = loadCSV;

    </script>
</body>
</html>
